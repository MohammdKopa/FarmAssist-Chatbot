<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FarmAssist - Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø²Ø§Ø±Ø¹</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;500;600&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --earth-brown: #5D4E37;
            --soil-dark: #3D3225;
            --leaf-green: #4A7C59;
            --leaf-light: #7CB686;
            --wheat-gold: #D4A84B;
            --sky-blue: #87CEEB;
            --cream: #F5F1E8;
            --sand: #E8DCC4;
            --text-dark: #2C2416;
            --text-light: #F5F1E8;
            --shadow: rgba(61, 50, 37, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', 'IBM Plex Sans Arabic', sans-serif;
            background: linear-gradient(145deg, var(--cream) 0%, var(--sand) 100%);
            min-height: 100vh;
            color: var(--text-dark);
        }

        body[dir="rtl"] {
            font-family: 'IBM Plex Sans Arabic', 'DM Sans', sans-serif;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--earth-brown) 0%, var(--soil-dark) 100%);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px var(--shadow);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--leaf-green);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logo-text {
            color: var(--text-light);
            font-weight: 700;
            font-size: 1.25rem;
            letter-spacing: -0.5px;
        }

        .lang-toggle {
            display: flex;
            gap: 0.5rem;
        }

        .lang-btn {
            background: transparent;
            border: 2px solid rgba(255,255,255,0.3);
            color: var(--text-light);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .lang-btn:hover, .lang-btn.active {
            background: var(--wheat-gold);
            border-color: var(--wheat-gold);
            color: var(--soil-dark);
        }

        /* Main Container */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 1.5rem;
            display: grid;
            grid-template-rows: 1fr auto;
            height: calc(100vh - 72px);
            gap: 1rem;
        }

        /* Chat Area */
        .chat-area {
            background: white;
            border-radius: 24px;
            box-shadow: 0 8px 40px var(--shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Messages */
        .message {
            max-width: 85%;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.bot {
            align-self: flex-start;
        }

        .message.user {
            align-self: flex-end;
        }

        .message-content {
            padding: 1rem 1.25rem;
            border-radius: 20px;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .message.bot .message-content {
            background: linear-gradient(135deg, var(--leaf-green) 0%, var(--leaf-light) 100%);
            color: white;
            border-bottom-left-radius: 8px;
        }

        body[dir="rtl"] .message.bot .message-content {
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 8px;
        }

        .message.user .message-content {
            background: var(--sand);
            color: var(--text-dark);
            border-bottom-right-radius: 8px;
        }

        body[dir="rtl"] .message.user .message-content {
            border-bottom-right-radius: 20px;
            border-bottom-left-radius: 8px;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .quick-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .quick-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        /* Map Container */
        .map-container {
            margin-top: 1rem;
            border-radius: 16px;
            overflow: hidden;
            height: 200px;
            border: 3px solid rgba(255,255,255,0.3);
        }

        #map {
            height: 100%;
            width: 100%;
        }

        /* Farm Report Card */
        .farm-report {
            background: rgba(255,255,255,0.15);
            border-radius: 16px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .report-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .report-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .report-item {
            background: rgba(255,255,255,0.2);
            padding: 0.75rem;
            border-radius: 12px;
            text-align: center;
        }

        .report-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .report-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .status-good { color: #90EE90; }
        .status-warning { color: #FFD700; }
        .status-alert { color: #FF6B6B; }

        /* Input Area */
        .input-area {
            padding: 1rem 1.5rem;
            background: var(--cream);
            border-top: 1px solid var(--sand);
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 1rem 1.25rem;
            border: 2px solid var(--sand);
            border-radius: 16px;
            font-size: 1rem;
            font-family: inherit;
            background: white;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--leaf-green);
            box-shadow: 0 0 0 4px rgba(74, 124, 89, 0.1);
        }

        .btn-icon {
            width: 50px;
            height: 50px;
            border-radius: 16px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.3s ease;
        }

        .btn-location {
            background: var(--wheat-gold);
            color: var(--soil-dark);
        }

        .btn-location:hover {
            background: #c49a3d;
            transform: scale(1.05);
        }

        .btn-send {
            background: var(--leaf-green);
            color: white;
        }

        .btn-send:hover {
            background: var(--leaf-light);
            transform: scale(1.05);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 1rem;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: rgba(255,255,255,0.6);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0.8); }
            40% { transform: scale(1.2); }
        }

        /* Scrollbar */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--sand);
            border-radius: 3px;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 1rem;
            }

            .chat-area {
                border-radius: 20px;
            }

            .message {
                max-width: 90%;
            }

            .report-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body dir="ltr">
    <header class="header">
        <div class="logo">
            <div class="logo-icon">ğŸŒ¾</div>
            <span class="logo-text">FarmAssist</span>
        </div>
        <div class="lang-toggle">
            <button class="lang-btn active" onclick="setLanguage('en')">EN</button>
            <button class="lang-btn" onclick="setLanguage('ar')">Ø¹Ø±Ø¨ÙŠ</button>
        </div>
    </header>

    <main class="container">
        <div class="chat-area">
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be inserted here -->
            </div>
            <div class="input-area">
                <input 
                    type="text" 
                    class="chat-input" 
                    id="chatInput" 
                    placeholder="Type your message..."
                    onkeypress="handleKeyPress(event)"
                >
                <button class="btn-icon btn-location" onclick="getLocation()" title="Share Location">
                    ğŸ“
                </button>
                <button class="btn-icon btn-send" onclick="sendMessage()" title="Send">
                    â¤
                </button>
            </div>
        </div>
    </main>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Configuration
        const CONFIG = {
            // Replace with your n8n webhook URL
            webhookUrl: 'YOUR_N8N_WEBHOOK_URL',
            language: 'en'
        };

        // Translations
        const TRANSLATIONS = {
            en: {
                welcome: "Hello! I'm your farm assistant ğŸŒ¾\n\nI can help you monitor your farm's health using satellite data. Here's what I can do:",
                placeholder: "Type your message...",
                quickActions: ["Register Farm", "Farm Status", "Weather", "Farming Tips"],
                registerPrompt: "Great! Please share your farm location by clicking the ğŸ“ button, or type your coordinates.",
                locationReceived: "Location received! I'm analyzing satellite data for your farm...",
                reportTitle: "ğŸŒ¾ Farm Health Report",
                vegetation: "Vegetation",
                moisture: "Moisture",
                health: "Health",
                trend: "Trend",
                tipPrefix: "ğŸ’¡ Tip:",
                error: "Sorry, I couldn't process that. Please try again."
            },
            ar: {
                welcome: "Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠ ğŸŒ¾\n\nÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ù…Ø±Ø§Ù‚Ø¨Ø© ØµØ­Ø© Ù…Ø²Ø±Ø¹ØªÙƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù‚Ù…Ø§Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©. Ø¥Ù„ÙŠÙƒ Ù…Ø§ ÙŠÙ…ÙƒÙ†Ù†ÙŠ ÙØ¹Ù„Ù‡:",
                placeholder: "Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...",
                quickActions: ["ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©", "Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø±Ø¹Ø©", "Ø§Ù„Ø·Ù‚Ø³", "Ù†ØµØ§Ø¦Ø­ Ø²Ø±Ø§Ø¹ÙŠØ©"],
                registerPrompt: "Ù…Ù…ØªØ§Ø²! ÙŠØ±Ø¬Ù‰ Ù…Ø´Ø§Ø±ÙƒØ© Ù…ÙˆÙ‚Ø¹ Ù…Ø²Ø±Ø¹ØªÙƒ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± ğŸ“ Ø£Ùˆ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª.",
                locationReceived: "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹! Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù‚Ù…Ø§Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ© Ù„Ù…Ø²Ø±Ø¹ØªÙƒ...",
                reportTitle: "ğŸŒ¾ ØªÙ‚Ø±ÙŠØ± ØµØ­Ø© Ø§Ù„Ù…Ø²Ø±Ø¹Ø©",
                vegetation: "Ø§Ù„Ù†Ø¨Ø§ØªØ§Øª",
                moisture: "Ø§Ù„Ø±Ø·ÙˆØ¨Ø©",
                health: "Ø§Ù„ØµØ­Ø©",
                trend: "Ø§Ù„Ø§ØªØ¬Ø§Ù‡",
                tipPrefix: "ğŸ’¡ Ù†ØµÙŠØ­Ø©:",
                error: "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø°Ù„Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."
            }
        };

        let currentLanguage = 'en';
        let userLocation = null;
        let map = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            showWelcomeMessage();
        });

        function setLanguage(lang) {
            currentLanguage = lang;
            CONFIG.language = lang;
            
            // Update UI direction
            document.body.dir = lang === 'ar' ? 'rtl' : 'ltr';
            
            // Update active button
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update placeholder
            document.getElementById('chatInput').placeholder = TRANSLATIONS[lang].placeholder;
            
            // Clear and show new welcome
            document.getElementById('chatMessages').innerHTML = '';
            showWelcomeMessage();
        }

        function showWelcomeMessage() {
            const t = TRANSLATIONS[currentLanguage];
            
            const welcomeHtml = `
                <div class="message-content">
                    ${t.welcome.replace(/\n/g, '<br>')}
                    <div class="quick-actions">
                        ${t.quickActions.map(action => 
                            `<button class="quick-btn" onclick="handleQuickAction('${action}')">${action}</button>`
                        ).join('')}
                    </div>
                </div>
            `;
            
            addMessage(welcomeHtml, 'bot', true);
        }

        function addMessage(content, sender, isHtml = false) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            if (isHtml) {
                messageDiv.innerHTML = content;
            } else {
                messageDiv.innerHTML = `<div class="message-content">${content}</div>`;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'message bot';
            indicator.id = 'typingIndicator';
            indicator.innerHTML = `
                <div class="message-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            document.getElementById('chatMessages').appendChild(indicator);
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function handleQuickAction(action) {
            const t = TRANSLATIONS[currentLanguage];
            const actionMap = {
                'Register Farm': 'register',
                'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø²Ø±Ø¹Ø©': 'register',
                'Farm Status': 'status',
                'Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø±Ø¹Ø©': 'status',
                'Weather': 'weather',
                'Ø§Ù„Ø·Ù‚Ø³': 'weather',
                'Farming Tips': 'tips',
                'Ù†ØµØ§Ø¦Ø­ Ø²Ø±Ø§Ø¹ÙŠØ©': 'tips'
            };
            
            addMessage(action, 'user');
            
            const intent = actionMap[action];
            
            if (intent === 'register') {
                setTimeout(() => {
                    addMessage(t.registerPrompt, 'bot');
                }, 500);
            } else if (intent === 'status') {
                if (userLocation) {
                    getFarmStatus();
                } else {
                    addMessage(t.registerPrompt, 'bot');
                }
            } else {
                sendToWebhook(action, intent);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addMessage(message, 'user');
            input.value = '';
            
            await sendToWebhook(message);
        }

        async function sendToWebhook(message, intent = null) {
            showTypingIndicator();
            
            try {
                const payload = {
                    message: message,
                    language: currentLanguage,
                    intent: intent,
                    location: userLocation,
                    timestamp: new Date().toISOString()
                };
                
                // If webhook URL is not configured, use demo mode
                if (CONFIG.webhookUrl === 'YOUR_N8N_WEBHOOK_URL') {
                    await simulateResponse(message, intent);
                    return;
                }
                
                const response = await fetch(CONFIG.webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                hideTypingIndicator();
                
                if (data.report) {
                    showFarmReport(data.report);
                } else if (data.message) {
                    addMessage(data.message, 'bot');
                }
                
            } catch (error) {
                hideTypingIndicator();
                addMessage(TRANSLATIONS[currentLanguage].error, 'bot');
                console.error('Error:', error);
            }
        }

        // Demo mode - simulates responses when no webhook is configured
        async function simulateResponse(message, intent) {
            await new Promise(resolve => setTimeout(resolve, 1500));
            hideTypingIndicator();
            
            const t = TRANSLATIONS[currentLanguage];
            
            if (intent === 'status' || message.toLowerCase().includes('status') || message.includes('Ø­Ø§Ù„Ø©')) {
                showFarmReport({
                    ndvi: 0.72,
                    moisture: 'Normal',
                    health: 'Good',
                    trend: 'Stable',
                    tip: currentLanguage === 'ar' 
                        ? 'Ù…Ø­Ø§ØµÙŠÙ„Ùƒ ÙÙŠ Ø­Ø§Ù„Ø© Ø¬ÙŠØ¯Ø©. Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ø±ÙŠ Ø§Ù„Ù…Ù†ØªØ¸Ù….'
                        : 'Your crops are healthy. Continue regular irrigation.'
                });
            } else if (intent === 'weather' || message.toLowerCase().includes('weather') || message.includes('Ø·Ù‚Ø³')) {
                const weatherMsg = currentLanguage === 'ar'
                    ? 'ğŸŒ¤ï¸ ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø·Ù‚Ø³:\n\nØ§Ù„ÙŠÙˆÙ…: Ù…Ø´Ù…Ø³ØŒ 28Â°Ù…\nØºØ¯Ø§Ù‹: ØºØ§Ø¦Ù… Ø¬Ø²Ø¦ÙŠØ§Ù‹ØŒ 26Â°Ù…\nÙØ±ØµØ© Ø£Ù…Ø·Ø§Ø±: 10%\n\nğŸ’¡ Ù†ØµÙŠØ­Ø©: Ø·Ù‚Ø³ Ù…Ø«Ø§Ù„ÙŠ Ù„Ù„Ø²Ø±Ø§Ø¹Ø©!'
                    : 'ğŸŒ¤ï¸ Weather Forecast:\n\nToday: Sunny, 28Â°C\nTomorrow: Partly cloudy, 26Â°C\nRain chance: 10%\n\nğŸ’¡ Tip: Great weather for farming!';
                addMessage(weatherMsg.replace(/\n/g, '<br>'), 'bot');
            } else if (intent === 'tips' || message.toLowerCase().includes('tips') || message.includes('Ù†ØµØ§Ø¦Ø­')) {
                const tipsMsg = currentLanguage === 'ar'
                    ? 'ğŸŒ± Ù†ØµØ§Ø¦Ø­ Ø²Ø±Ø§Ø¹ÙŠØ©:\n\n1. Ø§Ø³Ù‚Ù ÙÙŠ Ø§Ù„ØµØ¨Ø§Ø­ Ø§Ù„Ø¨Ø§ÙƒØ± Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªØ¨Ø®Ø±\n2. Ø±Ø§Ù‚Ø¨ Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù†Ø¨Ø§ØªØ§Øª Ù„Ù„ÙƒØ´Ù Ø§Ù„Ù…Ø¨ÙƒØ± Ø¹Ù† Ø§Ù„Ø¢ÙØ§Øª\n3. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØºØ·Ø§Ø¡ Ø§Ù„Ù†Ø¨Ø§ØªÙŠ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø±Ø·ÙˆØ¨Ø© Ø§Ù„ØªØ±Ø¨Ø©\n4. Ù‚Ù… Ø¨ØªØ¯ÙˆÙŠØ± Ø§Ù„Ù…Ø­Ø§ØµÙŠÙ„ ÙƒÙ„ Ù…ÙˆØ³Ù…'
                    : 'ğŸŒ± Farming Tips:\n\n1. Water early morning to reduce evaporation\n2. Monitor leaf color for early pest detection\n3. Use mulch to retain soil moisture\n4. Rotate crops each season';
                addMessage(tipsMsg.replace(/\n/g, '<br>'), 'bot');
            } else {
                const defaultMsg = currentLanguage === 'ar'
                    ? 'Ø´ÙƒØ±Ø§Ù‹ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„ØªÙƒ! ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ù…Ø²Ø±Ø¹ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ'
                    : 'Thanks for your message! How can I help with your farm today?';
                addMessage(defaultMsg, 'bot');
            }
        }

        function showFarmReport(report) {
            const t = TRANSLATIONS[currentLanguage];
            
            const healthClass = report.health === 'Good' || report.health === 'Ø¬ÙŠØ¯Ø©' ? 'status-good' : 
                               report.health === 'Warning' ? 'status-warning' : 'status-alert';
            
            const reportHtml = `
                <div class="message-content">
                    <div class="farm-report">
                        <div class="report-header">
                            ${t.reportTitle}
                        </div>
                        <div class="report-grid">
                            <div class="report-item">
                                <div class="report-value">${report.ndvi.toFixed(2)}</div>
                                <div class="report-label">NDVI</div>
                            </div>
                            <div class="report-item">
                                <div class="report-value">${report.moisture}</div>
                                <div class="report-label">${t.moisture}</div>
                            </div>
                            <div class="report-item">
                                <div class="report-value ${healthClass}">âœ“</div>
                                <div class="report-label">${t.health}: ${report.health}</div>
                            </div>
                            <div class="report-item">
                                <div class="report-value">â†’</div>
                                <div class="report-label">${t.trend}: ${report.trend}</div>
                            </div>
                        </div>
                    </div>
                    <br>${t.tipPrefix} ${report.tip}
                </div>
            `;
            
            addMessage(reportHtml, 'bot', true);
        }

        function getLocation() {
            const t = TRANSLATIONS[currentLanguage];
            
            if (!navigator.geolocation) {
                addMessage(currentLanguage === 'ar' 
                    ? 'Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹.'
                    : 'Browser doesn\'t support geolocation. Please enter coordinates manually.', 'bot');
                return;
            }
            
            addMessage(currentLanguage === 'ar' ? 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...' : 'Getting your location...', 'bot');
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    showLocationOnMap(userLocation);
                    addMessage(t.locationReceived, 'bot');
                    
                    // Automatically fetch farm status
                    setTimeout(() => getFarmStatus(), 1000);
                },
                (error) => {
                    addMessage(currentLanguage === 'ar'
                        ? 'ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹.'
                        : 'Couldn\'t get location. Please enter coordinates manually.', 'bot');
                }
            );
        }

        function showLocationOnMap(location) {
            const mapHtml = `
                <div class="message-content">
                    ğŸ“ ${currentLanguage === 'ar' ? 'Ù…ÙˆÙ‚Ø¹ Ù…Ø²Ø±Ø¹ØªÙƒ' : 'Your Farm Location'}
                    <br><small>${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}</small>
                    <div class="map-container" id="mapContainer"></div>
                </div>
            `;
            
            addMessage(mapHtml, 'bot', true);
            
            // Initialize map after DOM update
            setTimeout(() => {
                const mapContainer = document.getElementById('mapContainer');
                if (mapContainer && !map) {
                    map = L.map(mapContainer).setView([location.lat, location.lng], 15);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'Â© OpenStreetMap'
                    }).addTo(map);
                    L.marker([location.lat, location.lng]).addTo(map)
                        .bindPopup(currentLanguage === 'ar' ? 'Ù…Ø²Ø±Ø¹ØªÙƒ' : 'Your Farm')
                        .openPopup();
                }
            }, 100);
        }

        async function getFarmStatus() {
            if (!userLocation) {
                addMessage(TRANSLATIONS[currentLanguage].registerPrompt, 'bot');
                return;
            }
            
            await sendToWebhook('status', 'status');
        }
    </script>
</body>
</html>
